# Qbot Introduction
Qbot is dispatched in targeted attacks against businesses. With this Trojan, the attackers go after bank accounts of organizations or private users who access their personal online banking cabinets from corporate networks by piggybacking into banking sessions of the victim. The Trojan uses man-in-the-browser functionality to perform web-injections, allowing it to alter what the victims see on the banking website when browsing from an infected machine. Interestingly, while most malware samples that use this technique contain the web-injection code in their config file, Qbot is able to fetch the code from a controlled domain as it performs malicious activity. Another trait that differentiates Qbot from other Trojans is its worm-like functionality. Qbot can copy itself using shared drives and spread over the network, spreading on its own or after receiving a command from the command and control server. Together with a highly developed persistence mechanism that uses registry runkeys and scheduled tasks, these traits make erasing Qbot from the infected network very difficult.

# MDATP Advanced Hunting Queries
<details>
<summary>Hunting for Qbot activity using URLhaus's API for threat intelligence</summary>
<p>

```
// Hunting for Qbot activity using URLhaus's API for threat intelligence
let get_ext_data = (externaldata(raw_intel: string) [@"https://urlhaus.abuse.ch/downloads/csv_recent/"]
with (format="txt")
| where raw_intel !startswith "#"
| extend data = parse_csv(raw_intel)
| extend url = tostring(data[2])
| where data[5] has ("Qakbot") or data[5] has ("qbot") or data[5] has ("Quakbot"));
let urlhaus_domain = materialize (get_ext_data
| extend domain = extract("https?://([^/]+)", 1, tostring(data[2]))
| where domain !has "urldefense.com"
| project domain);
let urlhaus_url = materialize (get_ext_data
| project url);
let host_activity = materialize (urlhaus_domain
| join (DeviceNetworkEvents
| where Timestamp > ago (7d))
on $left.domain == $right.RemoteUrl
| distinct DeviceId);
let cmd_activity = materialize (host_activity
| join (DeviceProcessEvents
| where Timestamp > ago (7d))
on $left.DeviceId == $right.DeviceId
| project ProcessCommandLine);
let file_activity = materialize (host_activity
| join (DeviceFileEvents
| where Timestamp > ago (7d))
on $left.DeviceId == $right.DeviceId
| project InitiatingProcessCommandLine);
search in (DeviceEvents, DeviceNetworkEvents, DeviceProcessEvents, DeviceFileEvents, DeviceRegistryEvents)
Timestamp > ago (7d)
| where DeviceId in (host_activity) and 
    (RemoteUrl in (urlhaus_url) or 
    RemoteUrl in (urlhaus_domain) or 
    ProcessCommandLine has_any (urlhaus_domain) or 
    InitiatingProcessCommandLine has_any (urlhaus_domain) or 
    (ActionType=="BrowserLaunchedToOpenUrl" and InitiatingProcessCommandLine endswith ".zip\"") or 
    FileName=="Direct3DMX.exe" or 
    ActionType=="ProcessCreatedUsingWmiQuery" or 
    ($table=="DeviceNetworkEvents" and InitiatingProcessCommandLine=="explorer.exe") or 
    ProcessCommandLine endswith ".zip\"" or 
    (RegistryKey contains "\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" and RegistryValueData contains "\\AppData\\Roaming\\Microsoft\\"))
| sort by Timestamp
```

</p>
</details>
<details>
<summary>Hunting for Qbot process injection</summary>
<p>

```
//Hunting for Qbot process injection
DeviceProcessEvents 
| where FileName =~ "ping.exe"
| where InitiatingProcessFileName =~ "cmd.exe"
| where InitiatingProcessCommandLine has "calc.exe" and
InitiatingProcessCommandLine has "-n 6" 
and InitiatingProcessCommandLine has "127.0.0.1"
| sort by Timestamp
```
</p>
</details>

# Qbot In-Depth Historical
The Trojan is designed to sustain itself despite system reboots and can launch itself automatically when the system is turned on again. This infamous persistence functionality has allegedly caused compromise of sensitive information in two government organizations in Massachusetts in 2011, while worm-like behavior helped the Qbot to infiltrate thousands of machines and create a botnet with over 1,500 devices as the result of that attack. Most of the targets that Qbot goes after are US-based organizations. Only about twenty percent of the targets are located outside of the United States. Although apart from the government offices most of the attacks have been directed at banking, tech and healthcare industries, there is no hard evidence to suggest that the attackers are aiming at specific fields. This means that business working in any industry can get hit by Qbot.

It is also important to note that the malware is operated by an advanced cybergang. Qbot attacks have been appearing on the radar of security researchers periodically, with phases of high activity and intervals when attacks would completely stop. This behavior is likely a way to avoid attracting too much attention from law enforcement and also allows attackers to tweak and improve the malware during their time off. The group behind Qbot is also notoriously known for pushing out new modified samples of the malware at astonishing rates. They repack and re-scramble the code on a daily basis, making malware identification by means of anti-virus software unreliable. Unfortunately, the identities of people behind Qbot are unknown, but it is widely believed that the cyber gang is based somewhere in Eastern Europe.

# Qbot Behaviorals, TTPs & IOCs
Since Qbot is mostly targeted at the corporate sector, the main way of its penetration into infected systems is through a malicious document. In our example, maldoc starts several processes including Powershell through by using a macro. Then, using cmd.exe this trojan starts a chain of commands and executions, creating folders and temporary files. It utilizes Powershell to download the payload. It is notable that very often the name of the payload is as simple as six of the same digits or, less often, letters. Also, the payload often has a .png extension, although it is an executable file.

After that trojan starts its main execution, Qbot tries to evade detection by overwriting itself with the legitimate Windows executable calc.exe using following commands: cmd.exe /c ping.exe -n 6 127.0.0.1 & type "C:\Windows\System32\calc.exe" > “Path to malware executable”. Qbot also injects explorer.exe and adds itself into autorun for persistence.

Qbot uses multiple attack vectors to infect victims. The malware uses email spam and phishing campaigns, as well as vulnerability exploits to infiltrate its targets. One of the more recent versions of the malware was observed being distributed by a dropper. The dropper that installs Qbot is equipped with a delayed execution function. This means that after the dropper itself is downloaded onto a target machine, it waits around fifteen minutes before dropping the payload, likely in an effort to trick automatic sandboxes and avoid detection.

Qbot trojan creates files that allow analysts to detect it with a high degree of certainty. To detect Qbot, take a look at the created folders. If you see folders with names such as "Zulycjadyc" and "imtaykad" within C:\Users\admin\AppData\ oaming\Microsoft\ directory and .exe or .dat file with a name "ytfovlym", be sure that it is Qbot in front of you.

* Any.Run demo -> https://app.any.run/tasks/f73e8627-5a3e-4810-84cb-3f5b64a980f3/
* Any.Run submissions -> https://app.any.run/submissions/#tag:qbot
* URLhaus submissions:
     * https://urlhaus.abuse.ch/browse/tag/qbot/
     * https://urlhaus.abuse.ch/browse/tag/qakbot/
     * https://urlhaus.abuse.ch/browse/tag/quakbot/
