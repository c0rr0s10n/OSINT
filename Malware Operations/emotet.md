# Emotet Introduction
Emotet is an extremely sophisticated and destructive Trojan used to download and install other malware. First recorded in 2014 it was classified as a banking trojan, but Emotet has gained advanced capabilities over the course of its lifetime and evolved into an entire malware distribution service. 

So what makes Emotet virus so dangerous? Emotet can act like a worm and spread using local networks, which makes it extremely hard to clean-up. In addition to this, the Trojan has advanced persistence and anti-evasion mechanics, such as the ability to detect sandboxes and virtual machines with an option to generate false indicators to throw researches off. On top of that, the Trojan has a polymorphic design – meaning that it can change its code to bypass signature-based detection, making this cyber defense strategy useless against its’ attacks. If that wasn’t enough, Emotet can receive updates from the control server, performing this operation as if an operating system update is being installed. This allows the Trojan to drop additional malware onto the infected machine stealthily. It should also be noted that Emotet trojan has a modular design which makes it possible to adapt this malware to various tasks and customize it for every particular campaign, giving the attackers the maximum flexibility. Today Emotet is targeting governments, corporations, small businesses, and individuals, focusing on Europe, America, and Canada.

# MDATP Advanced Hunting Queries
<details>
<summary>Hunting for Emotet activity using URLhaus's API for threat intelligence</summary>
<p>
    
```
// Hunting for Emotet activity using URLhaus's API for threat intelligence
let get_ext_data = (externaldata(raw_intel: string) [@"https://urlhaus.abuse.ch/downloads/csv_recent/"]
with (format="txt")
| where raw_intel !startswith "#"
| extend data = parse_csv(raw_intel)
| extend url = tostring(data[2])
| where data[5] has ("emotet") or data[5] has ("heodo"));
let urlhaus_domain = materialize (get_ext_data
| extend domain = extract("https?://([^/]+)", 1, tostring(data[2]))
| where domain !has "urldefense.com"
| project domain);
let urlhaus_url = materialize (get_ext_data
| project url);
let host_activity = materialize (urlhaus_url
| join (DeviceEvents
| where Timestamp > ago (7d))
on $left.url == $right.RemoteUrl
| distinct DeviceId);
let cmd_activity = materialize (host_activity
| join (DeviceProcessEvents
| where Timestamp > ago (7d))
on $left.DeviceId == $right.DeviceId
| project ProcessCommandLine);
let file_activity = materialize (host_activity
| join (DeviceFileEvents
| where Timestamp > ago (7d))
on $left.DeviceId == $right.DeviceId
| project InitiatingProcessCommandLine);
search in (DeviceEvents, DeviceNetworkEvents, DeviceProcessEvents, DeviceFileEvents)
Timestamp > ago (7d)
| where DeviceId in (host_activity) and 
    (RemoteUrl in (urlhaus_url) or 
    RemoteUrl in (urlhaus_domain) or 
    ProcessCommandLine has_any (urlhaus_domain) or 
    (
        (
            InitiatingProcessCommandLine has_any (urlhaus_domain) or 
            (InitiatingProcessFileName=="iexplore.exe" or InitiatingProcessFileName=="chrome.exe" or InitiatingProcessFileName=="msedge.exe" or InitiatingProcessFileName contains "MicrosoftEdge")
        ) and FileName endswith ".doc")
    )
| sort by Timestamp
```
</p>
</details>

# YARA Rule (Delivery Detection)
<details>
<summary>Email Hunting in Cofense</summary>
<p>
    
```YARA
meta:
  rule_context="Internal Safe"
strings: 
  $subj0=/Subject\:\s(.*\:\s)?\[EXTERNAL\]\s\w+,\s\w+((\s\w\.)|(.*\(\w+\)|.*@va\.gov))/ nocase
  $subj1=/UPS\sShip\sNotification\,\sTracking\sNumber\s\d/ ascii
  $subj2=/Please\sapprove/ nocase
  $subj3=/Quote\sverification/ nocase
  $subj4=/Past\sDue\sinvoice/ nocase
  $subj5=/open\sinvoice/ nocase
  $subj6=/Veterans\sto\smeet\sin\sMarch/ nocase
  $subj7=/LEX-CHIP\sQuarterly\sMeeting/ nocase
  $rare0=/Subject\:\s(.*\:\s)?\[EXTERNAL\](\s.*\:)?\s\w+,?\s\w+/ nocase
  $relay0=/Received:\sfrom\s\w+\.websitewelcome\.com/ nocase
  $relay1=/Received:\sfrom\s\w+\.syncdot\.com/ nocase
  $relay2=/Received:\sfrom\s\w+\.bizmail\.nifty\.com/ nocase
  $relay3=/Received:\sfrom\s\w+\.maychuemail\.com/ nocase
  $relay4=/Received:\sfrom\s\w+\.elcastillorio\.com\.mx/ nocase
  $domain0=/From\:.*sharepointonline\.com/ nocase
  $domain1=/From\:.*ups\.com/ nocase
  $domain2=/From\:.*microsoft\.com/ nocase
  $internal0=/X\-MS\-Exchange\-Organization\-AuthAs\:\sInternal/ fullword
  $internal1=/x-sharing-wssbaseurl:\s.*va\.gov.*/ nocase
  $mailer=/X-Mailer:\sMicrosoft\sOutlook/ nocase
condition:
  ((any of ($subj*)) or ($rare0 and any of ($relay*))) and (not any of ($domain*) and not any of ($internal*) and not $mailer)
```
</p>
</details>

# Emotet In-Depth Historical
The first version of Emotet malware which was spotted in the wild all the way back in 2014 was designed to steal banking credentials by intercepting internet traffic and was much more basic than the beast of a Trojan which we know today. When Emotet was first spotted in the wild, the malware targeted mainly banks from Germany and Austria using only its native information stealing toolset. Version two followed shortly after, this time carrying several additional modules such as a money transfer, mail spam, DDoS and address book stealing modules. The third iteration of Emotet was released in 2015, this time focusing on upgrading the anti-evasion functionality of the malware and introducing banks from Switzerland into the list of potential victims. The next overhaul of the Emotet malware followed in December 2016, changing the attack vector of the virus. At the beginning of its lifetime Version 4 heavily relied on the RIG 4.0 exploit kit to make its way into the victims' computers later switching primarily to mail spam. The same iteration of the malware also marked the moment when the primary use case of the malware started shifting from using its own banking module to dropping other Trojans onto infected machines.

Speaking of modules, Emotet malware can perform a large number of malicious activities that vary depending on the modules used in a particular campaign. Most versions of the virus included a spam module which can be used to continue the spread of the malware by sending out a series of malicious emails from the infected machine. Another normally included module is the one used for credential stealing, allowing Emotet to steal sensitive information from web browsers and mail clients. Starting from 2017, Emotet trojan began coming equipped with a spreader module, allowing the malware to infect all machines connected via a local network. The virus also gained the address book stealer module – this one is interesting. It analyzes the relationship between email senders and receivers and uses the collected information to enhance the effectiveness of subsequent campaigns originating from the users’ PC, allowing to target friends, family members and colleagues of the victim with personalized spam emails. Not only does Emotet malware provide flexible functionality through the use of modules and has several anti-evasion functions, but it also puts a heavy emphasis on persistence. To ensure that the malware stays in the infected machine, it injects into running processes, often targeting the Explorer.exe. In addition to that, the malware uses Scheduled Tasks and makes registry keys changes.

It should be noted that the Trojan we are reviewing today is extremely destructive and its attacks can have several consequences, such as loss of private data, inability to operate the infected PC up to its complete disability and financial losses associated with restoring the infrastructure damaged by the malware. In fact, one company was forced to spend an excess of one million dollars to deal with the aftermath of an Emotet attack.

# Emotet Behaviorals, TTPs & IOCs
Considering that the primary way in which the Emotet trojan is distributed is malicious email spam campaigns, the first step in the chain of infection involves tricking the potential victim into opening an attached Microsoft Office file using social engineering. After the file has been opened and macros enabled, there is no need for additional user actions. Downloaded files contain malicious VBA code which runs after a document has been opened. One of the possible options of the infection process is when the VBA code utilizes WMI to launch a Powershell script which downloads the payload – a malicious executable file from the webserver. Notably, the Powershell script is encoded. Emotet makes steps to maintain a presence in the infected system - it copies itself into %AppData% subfolders and changes the autorun value in the registry. Through all infection process, the malware sends information to and from a server. As the last execution step, Emotet waits for commands from C2 servers.

The main distribution method of Emotet malware is malicious email campaigns. The trojan uses it’s address book stealer module to pull the contacts from the email account of its victim and send itself to found contacts from the hijacked account. Bearing in mind that potential victims are receiving an email from somebody they know and trust, Emotet has a very high chance of a successful attack. The received email usually contains a link to a malicious URL that downloads the malware when clicked. However, email spam is not the only distribution Method that this malware utilizes. It may also take advantage of certain Windows vulnerabilities, thus the malware can make it’s way into a machine completely “silently”, without the user ever knowing about it.

* Any.Run demo -> https://app.any.run/tasks/f75fc5d0-a70b-492b-8f0e-1805277d9193/
* Any.Run submissions -> https://app.any.run/submissions/#tag:emotet
* URLhaus submissions:
     * https://urlhaus.abuse.ch/browse/tag/emotet/
     * https://urlhaus.abuse.ch/browse/tag/heodo/
     * https://urlhaus.abuse.ch/browse/tag/geodo/
